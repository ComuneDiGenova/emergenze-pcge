<?php

/*$query_comunicazioni="SELECT *";
$query_comunicazioni= $query_comunicazioni." FROM segnalazioni.v_comunicazioni 
WHERE id_lavorazione=".$id_lavorazione. ";";
*/
$query_comunicazioni="SELECT *";
if ($check_segnalazione==1){
	$query_comunicazioni= $query_comunicazioni." FROM segnalazioni.v_comunicazioni WHERE id_lavorazione=".$id_lavorazione. " 
	order by to_timestamp(data_ora_stato, 'DD/MM/YYYY HH24:MI:SS'::text);";
} else {
	$query_comunicazioni= $query_comunicazioni." FROM segnalazioni.v_comunicazioni_incarichi WHERE id=".$id. " 
	order by to_timestamp(data_ora_stato, 'DD/MM/YYYY HH24:MI:SS'::text);";
} 

//echo $query_comunicazioni;
$result_comunicazioni=pg_query($conn, $query_comunicazioni);
$check_messaggi_notifica=0;
$testo="";
while($r_comunicazioni = pg_fetch_assoc($result_comunicazioni)) {
	$check_messaggi_notifica=$check_messaggi_notifica+1;
	if ($check_messaggi_notifica>0){
		$testo= $testo. "<hr>";
	}
	$i=$i+1;
	$testo= $testo. "<i class=\"fa fa-comment\"></i> ". $r_comunicazioni['data_ora_stato'];
	$testo= $testo. " - Da " .$r_comunicazioni['mittente']. " a ". $r_comunicazioni['destinatario'];
	$testo= $testo. " : " .$r_comunicazioni['testo'];
	if ($r_comunicazioni['allegato']!=''){
		$allegati=explode(";",$r_comunicazioni['allegato']);
		// Count total files
		$countfiles = count($allegati);
		// Looping all files
		if($countfiles > 0) {
			for($i=0;$i<$countfiles;$i++){
				$n_a=$i+1;
				$testo= $testo. ' - <a href="../../'.$allegati[$i].'"> Allegato '.$n_a.'</a>';
			}
		}
	}
}



?>


<div class="panel-group">
			  <div class="panel panel-success">
			    <div class="panel-heading">
			      <h4 class="panel-title">
			        <a data-toggle="collapse" href="#list_comunicazioni"><i class="fa fa-comments"></i>
					<?php
					if ($check_segnalazione==1){
					?>
						Visualizza tutte le comunicazioni sulla segnalazione 
						
					<?php if ($check_messaggi_notifica > 0 ){ 
			        echo "( "; 
			        ?>
			        <i class="fas fa-envelope faa-ring animated" style="color:#ff0000"></i>
			        <?php 
			        echo " ".$check_messaggi_notifica. ")"; 
			         } ?>						
						
					<?php
					} else {
					?>
						Visualizza tutte le comunicazioni sull'incarico
					
					<?php if ($check_messaggi_notifica > 0 ){ 
			        echo "( "; 
			        ?>
			        <i class="fas fa-envelope faa-ring animated" style="color:#ff0000"></i>
			        <?php 
			        echo " ".$check_messaggi_notifica. ")"; 
			         } ?>
					
					<?php
					} 
					?>
					</a>
			      </h4>
			    </div>
			    <div id="list_comunicazioni" class="panel-collapse collapse">
			      <div class="panel-body"-->
				<?php
				// cerco l'id_lavorazione
				/*$query_comunicazioni="SELECT *";
				if ($check_segnalazione==1){
					$query_comunicazioni= $query_comunicazioni." FROM segnalazioni.v_comunicazioni WHERE id_lavorazione=".$id_lavorazione. " 
					order by to_timestamp(data_ora_stato, 'DD/MM/YYYY HH24:MI:SS'::text);";
				} else {
					$query_comunicazioni= $query_comunicazioni." FROM segnalazioni.v_comunicazioni_incarichi WHERE id=".$id. " 
					order by to_timestamp(data_ora_stato, 'DD/MM/YYYY HH24:MI:SS'::text);";
				} 
				
				//echo $query_comunicazioni;
				//$result_comunicazioni=pg_query($conn, $query_comunicazioni);
				$i=0;
				while($r_comunicazioni = pg_fetch_assoc($result_comunicazioni)) {
					if ($i>0){
						echo "<hr>";
					}
					$i=$i+1;
					echo "<i class=\"fa fa-comment\"></i> ". $r_comunicazioni['data_ora_stato'];
					echo " - Da " .$r_comunicazioni['mittente']. " a ". $r_comunicazioni['destinatario'];
					echo " : " .$r_comunicazioni['testo'];
					if ($r_comunicazioni['allegato']!=''){
						echo '<a href="../../'.$r_comunicazioni['allegato'].'"> Allegato </a>';
					}
					//echo " - <a class=\"btn btn-info\" href=\"dettagli_incarico.php?id=".$r_comunicazioni['id']."\"> <i class=\"fas fa-info\"></i> Dettagli</a>";
				}*/
				echo $testo;
					$page = basename($_SERVER['PHP_SELF']);
					if ($page=='dettagli_segnalazione.php' and $check_lav>=0){
					?>
						<br><hr>
						<button type="button" class="btn btn-info"  data-toggle="modal" data-target="#comunicazione"><i class="fas fa-comment"></i> Invia comunicazione</button>
					<?php
					}
					?>
				
			
			
			</div>
    </div>
  </div>
</div>








<!-- Modal comunicazione da UO-->
<div id="comunicazione" class="modal fade" role="dialog">
  <div class="modal-dialog">

	<!-- Modal content-->
	<div class="modal-content">
	  <div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">&times;</button>
		<h4 class="modal-title">Comunicazioni sulla segnalazione</h4>
	  </div>
	  <div class="modal-body">
	  

		<form autocomplete="off"  enctype="multipart/form-data"  action="incarichi/comunicazione.php?id=<?php echo $id; ?>" method="POST">
			<input type="hidden" name="mittente" value="<?php echo $cognome." " .$nome. " (".$descrizione_profilo.")";?>" />
			<input type="hidden" name="id_lavorazione" value="<?php echo $r['id_lavorazione'];?>" />
			<input type="hidden" name="id_evento" value="<?php echo $id_evento;?>" />
				 <div class="form-group">
				<label for="note">Testo comunicazione <?php echo $id_evento;?></label>  <font color="red">*</font>
				<textarea required="" class="form-control" id="note"  name="note" rows="3"></textarea>
			  </div>
			
			<!--	RICORDA	  enctype="multipart/form-data" nella definizione del form    -->



				
				<style type="text/css">
				#fileList > div > label > span:last-child {
					color: red;
					display: inline-block;
					margin-left: 7px;
					cursor: pointer;
				}
				#fileList input[type=file] {
					display: none;
				}
				#fileList > div:last-child > label {
					display: inline-block;
					width: 23px;
					height: 23px;
					font: 16px/22px Tahoma;
					color: orange;
					text-align: center;
					border: 2px solid orange;
					border-radius: 50%;
				}
				</style>

			<div class="form-group file">
			   <label for="note">Eventuali allegati</label>
			   <div id="fileList">
					<div>
						<input id="fileInput_0" type="file" name="userfile[]" />
						<label for="fileInput_0">+</label>      
					</div>
				</div>
			</div>

				<script type="text/javascript" >
				var fileInput = document.getElementById('fileInput_0');
				var filesList =  document.getElementById('fileList');  
				var idBase = "fileInput_";
				var idCount = 0;
				
				var inputFileOnChange = function() {
				
					var existingLabel = this.parentNode.getElementsByTagName("LABEL")[0];
					var isLastInput = existingLabel.childNodes.length<=1;
				
					if(!this.files[0]) {
						if(!isLastInput) {
							this.parentNode.parentNode.removeChild(this.parentNode);
						}
						return;
					}
				
					var filename = this.files[0].name;
				
					var deleteButton = document.createElement('span');
					deleteButton.innerHTML = '&times;';
					deleteButton.onclick = function(e) {
						this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode);
					}
					var filenameCont = document.createElement('span');
					filenameCont.innerHTML = filename;
					existingLabel.innerHTML = "";
					existingLabel.appendChild(filenameCont);
					existingLabel.appendChild(deleteButton);
					
					if(isLastInput) {	
						var newFileInput=document.createElement('input');
						newFileInput.type="file";
						newFileInput.name="file[]";
						newFileInput.id=idBase + (++idCount);
						newFileInput.onchange=inputFileOnChange;
						var newLabel=document.createElement('label');
						newLabel.htmlFor = newFileInput.id;
						newLabel.innerHTML = '+';
						var newDiv=document.createElement('div');
						newDiv.appendChild(newFileInput);
						newDiv.appendChild(newLabel);
						filesList.appendChild(newDiv);
					} 
				}
				
				fileInput.onchange=inputFileOnChange;
				</script>


		<button  id="conferma" type="submit" class="btn btn-primary">Invia comunicazione</button>
			</form>

	  </div>
	  <div class="modal-footer">
		<button type="button" class="btn btn-default" data-dismiss="modal">Annulla</button>
	  </div>
	</div>

  </div>
</div>
	



<?php

?>